elemental double precision function relu(x)
double precision, intent(in) :: x
if(x.ge.0.D0) then
relu = x
else
relu = 0.D0
end if 
return
end function


double precision function beta_ann(data_in)
double precision, dimension(6), intent(in) :: data_in
double precision, dimension(6) :: data_inputs
double precision, dimension(12,6), intent(in) :: weight_ann_hc_pure_1=reshape((/ &
0.683947703706851,&
0.751236466354445,&
0.0586173081289307,&
-0.559227168115033,&
-0.529462375191061,&
-1.05431961898437e-05,&
-0.584227321822418,&
-0.646147312331225,&
0.452832398132738,&
0.456254459654262,&
0.430591807420611,&
-0.00327920154085667,&
0.370106464402196,&
-0.34658284152416,&
0.00223609647573026,&
0.326200239734041,&
-0.290257621656068,&
-0.000347378179723216,&
-2.13699935938095e-29,&
-9.45035533487232e-29,&
1.43711129576897e-28,&
4.29618135608145e-29,&
7.20496848335955e-29,&
-7.47592026553007e-29,&
/),shape(weight_ann_hc_pure_1))
double precision, dimension(2,12), intent(in) :: weight_ann_hc_pure_2=reshape((/ &
-0.0719710956517362,&
-0.0335302190047631,&
0.674113936537917,&
7.70079200023622e-29,&
0.717884546224336,&
0.453248699500871,&
-0.0202135421288485,&
-0.607171373544747,&
-0.0839964748291403,&
0.0595034531500327,&
-0.609078778459772,&
-0.0432384826628136,&
1.30440271612654,&
-1.3712731592151,&
-0.0115012377312724,&
-2.2267000137735e-29,&
-0.0361312662098877,&
-0.0454745583912274,&
-2.07005035320887,&
0.234149536861783,&
-0.834849272544102,&
0.707303743820963,&
0.0619283637253709,&
2.2568792220521,&
/),shape(weight_ann_hc_pure_2))
double precision, dimension(12), intent(in) :: b_ann_hc_pure_1
double precision, dimension(2), intent(in) :: b_ann_hc_pure_2
double precision, dimension(6) :: min_in=(/ log10(1e-29),&
log10(1e-29),&
10047551.6125148,&
log10(2.5488000925875e-24),&
log10(2.10601093458117e-24),&
log10(2000.0) /)
double precision, dimension(6) :: max_in=(/ log10(6e-18),&
log10(3e-18),&
796886585.002239,&
log10(1.14849012070595e-10),&
log10(5.40387367367813e-11),&
log10(4000.0) /)
double precision, dimension(2) :: output_min_out=(/ log10(6.75552413335702e-09),&
6.75552413335702e-09,&
double precision, dimension(2) :: output_max_out=(/ log10(1.29620372987691e-15),&
1.29620372987691e-15,&
double precision, dimension(12) :: x_hidden_1
double precision, dimension(2) :: beta_results


data_inputs(1) =  -1.D0+ 2.D0*(log10(data_in(1)) - min_in(1))/(max_in(1) - min_in(1))
data_inputs(2) =  -1.D0+ 2.D0*(log10(data_in(2)) - min_in(2))/(max_in(2) - min_in(2))
data_inputs(3) =  -1.D0+ 2.D0*(data_in(3) - min_in(3))/(max_in(3) - min_in(3))
data_inputs(4) =  -1.D0+ 2.D0*(log10(data_in(4)) - min_in(4))/(max_in(4) - min_in(4))
data_inputs(5) =  -1.D0+ 2.D0*(log10(data_in(5)) - min_in(5))/(max_in(5) - min_in(5))
data_inputs(6) =  -1.D0+ 2.D0*(data_in(6) - min_in(6))/(max_in(6) - min_in(6))
!LAYER 1
x_hidden_1 = matmul(weight_ann_hc_pure_1, data_inputs)
x_hidden_1 = x_hidden_1+b_ann_hc_pure_1
x_hidden_1 = relu(x_hidden_1)


!OUTPUT LAYER
beta_results = matmul(weight_ann_hc_pure_2, x_hidden_1)
beta_results = beta_results +b_ann_hc_pure_2
beta_results(1) = 0.5D0*(beta_results(1) + 1.D0)*(output_max_out(1) - output_min_out(1)) +output_min_out(1)
beta_results(1) = 10**beta_results(1)
beta_results(2) = 0.5D0*( beta_results(2)+ 1.D0)*(output_max_out(2) - output_min_out(2)) +output_min_out(2)
beta_2out = beta_results(2)*beta_results(1) + beta_results(1)
return
end function

subroutine load_weights_bias4beta_2out(file_name)
character(len=100) :: file_name,f1,f2,f3
integer :: n_layers,n_inputs, i,j,off

f1 = trim(file_name)//'_arch.txt'
open(unit=88,file=f1)
read(88,*) n_inputs
read(88,*) n_layers
close(88)

f2 = trim(file_name)//'_weights.txt'
open(unit=88,file=f2)
do i = 1,size(weight_ann_hc_pure_1,1)
do j = 1,size(weight_ann_hc_pure_1,2)
read(88,*) weight_ann_hc_pure_1(i,j)
off = off +1
end do
end do
! FINAL LAYER
do i = 1,size(weight_ann_hc_pure_2,1)
do j = 1,size(weight_ann_hc_pure_2,2)
read(88,*) weight_ann_hc_pure_2(i,j)
off = off +1
end do
end do
close(88)

! biases
f3 = trim(file_name)//'_bias.txt'
open(unit=88,file=f3)
do i = 1,size(b_ann_hc_pure_1)
read(88,*) b_ann_hc_pure_1(i)
end do
do i = 1,size(b_ann_hc_pure_2)
read(88,*) b_ann_hc_pure_2(i)
end do
close(88)
end subroutine
subroutine load_scaling(file_name)
character(len=100) :: file_name,f1,f2,f3
integer :: i,j

f1 = trim(file_name)//'_scaling_params.txt'
open(unit=88,file=f1)
read(88,*) min_in(1),max_in(1)
min_in(1) = log10(min_in(1))
max_in(1) = log10(max_in(1))
read(88,*) min_in(2),max_in(2)
min_in(2) = log10(min_in(2))
max_in(2) = log10(max_in(2))
read(88,*) min_in(3),max_in(3)
read(88,*) min_in(4),max_in(4)
min_in(4) = log10(min_in(4))
max_in(4) = log10(max_in(4))
read(88,*) min_in(5),max_in(5)
min_in(5) = log10(min_in(5))
max_in(5) = log10(max_in(5))
read(88,*) min_in(6),max_in(6)
read(88,*) output_min_out(1),output_max_out(1)
output_min_out(1) = log10(output_min_out(1))
output_max_out(1) = log10(output_max_out(1))
read(88,*) output_min_out(2),output_max_out(2)
close(88)
end subroutine

end module